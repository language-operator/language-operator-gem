# Implementation Plan: Fix 4 Symbolic Task Execution Test Failures

## Issue Analysis

Issue #121 claims "syntax errors" but the actual failures are:

1. **Word count assertion error** (line 106) - Test expects 8, got 9
2. **AST validator blocks `raise`** (line 227) - Security system rejects exception raising
3. **Missing input type validation** (line 261) - Type validation not enforced
4. **Missing output schema validation** (line 285) - Schema validation not enforced

## Root Causes

### Failure 1: Word Count Off-by-One
- Test text: `'Hello world! This is a test. How are you?'`
- Current split: `/\s+/` counts all whitespace-separated tokens
- Assertion expects 8 words, actual is 9 (likely counting punctuation)
- **Fix**: Adjust test expectation or word counting logic

### Failure 2: AST Validator Blocks `raise`
- Location: [ast_validator.rb:98](lib/language_operator/agent/safety/ast_validator.rb#L98)
- `raise` is in DANGEROUS_METHODS list
- Test intentionally uses `raise ArgumentError, "Cannot divide by zero"`
- **Options**:
  - A) Allow `raise` for standard Ruby exceptions (safe)
  - B) Rewrite test to not use `raise` (changes test intent)
  - **Recommendation**: Option A - `raise` is essential for error handling

### Failure 3 & 4: Wrong Exception Type in Validation
- Type/schema validation IS implemented in TaskDefinition.validate_inputs/validate_outputs
- TypeCoercion.validate_array raises `ArgumentError: "Expected array, got String"` ✅
- TaskDefinition.coerce_value catches and re-raises `ArgumentError` with context
- **Problem**: Tests expect `TaskValidationError`, but code raises `ArgumentError`
- **Fix**: TaskDefinition.coerce_value should raise `TaskValidationError` instead
- **Location**: [lib/language_operator/dsl/task_definition.rb:279-284](lib/language_operator/dsl/task_definition.rb#L279-L284)

## Investigation Plan

1. ✅ Verify test failures (all 4 failures confirmed)
2. ✅ Check AST validator - `raise` is in DANGEROUS_METHODS list
3. ✅ Check TaskExecutor validation - calls task.validate_inputs/validate_outputs
4. ✅ Check TypeCoercion - raises ArgumentError, not TaskValidationError
5. ✅ Check word count - split by /\s+/ gives 9 words (punctuation attached)

## Implementation Approach

### Fix 1: Word Count Test (Line 106)
**File**: spec/integration/symbolic_task_execution_spec.rb
**Change**: Update expectation from `eq(8)` to `eq(9)`
**Reason**: `'Hello world! This is a test. How are you?'.split(/\s+/)` produces 9 tokens
**Tokens**: ["Hello", "world!", "This", "is", "a", "test.", "How", "are", "you?"]

### Fix 2: Allow `raise` in AST Validator (Line 227)
**File**: lib/language_operator/agent/safety/ast_validator.rb
**Change**: Remove `raise` and `fail` from DANGEROUS_METHODS list (line 28)
**Reason**:
  - `raise` is essential for proper Ruby error handling
  - Used to raise standard exceptions (ArgumentError, TypeError, etc.)
  - Cannot escape sandbox - exceptions propagate up to agent runtime
  - No security risk - just control flow
**Alternative**: Could allow only standard library exceptions, but removing entirely is simpler

### Fix 3 & 4: Raise TaskValidationError (Lines 261, 285)
**File**: lib/language_operator/dsl/task_definition.rb
**Change**: In `coerce_value` method (line 279-284), catch `ArgumentError` and raise `TaskValidationError`
**Current**:
```ruby
def coerce_value(value, type, context)
  TypeCoercion.coerce(value, type)
rescue ArgumentError => e
  raise ArgumentError, "#{e.message} for #{context}"
end
```
**New**:
```ruby
def coerce_value(value, type, context)
  TypeCoercion.coerce(value, type)
rescue ArgumentError => e
  raise TaskValidationError.new(@name, "#{e.message} for #{context}", e)
end
```
**Impact**: Changes exception type from ArgumentError to TaskValidationError for validation failures

## Files to Modify

### 1. lib/language_operator/agent/safety/ast_validator.rb
- Line 28: Remove `raise fail` from DANGEROUS_METHODS
- Impact: Allows error handling in symbolic tasks

### 2. lib/language_operator/dsl/task_definition.rb
- Lines 279-284: Change exception type in `coerce_value` method
- Add: `require_relative '../agent/task_executor'` at top
- Impact: Validation errors now use correct exception class

### 3. spec/integration/symbolic_task_execution_spec.rb
- Line 106: Change `eq(8)` to `eq(9)`
- Impact: Fixes off-by-one word count assertion

## Risks & Considerations

### Security - Allowing `raise`
- **Risk**: Could `raise` be used to escape sandbox?
  - **Analysis**: No. Exceptions propagate through call stack to agent runtime
  - Sandbox boundary is AST validation + binding restrictions, not exception handling
  - Standard exceptions (ArgumentError, etc.) are safe
- **Decision**: Safe to allow. Essential for error handling.

### Backward Compatibility - TaskValidationError
- **Risk**: Existing agents may catch `ArgumentError` for validation failures
  - **Impact**: Low - internal validation, most code doesn't catch this
  - TaskValidationError is a subclass of TaskExecutionError (StandardError)
  - Most exception handling uses generic `rescue` or `rescue StandardError`
- **Decision**: Safe. Tests already expect this behavior.

### Performance
- No performance impact - only changes exception class, not validation logic

## Testing Strategy

1. **Fix 1** → Run test at line 106 → Should pass
2. **Fix 2** → Run test at line 227 → Should pass
3. **Fix 3** → Run tests at lines 261, 285 → Should pass
4. **All fixes** → Run full integration suite
5. **Unit tests** → Verify no regressions
6. **Linter** → Run RuboCop
7. **Manual test** → Create agent with symbolic task that raises exception
# Test fixes completed
