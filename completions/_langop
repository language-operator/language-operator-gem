#compdef langop

# zsh completion for langop

_langop() {
    local -a commands
    local curcontext="$curcontext" state line
    typeset -A opt_args

    commands=(
        'cluster:Manage language clusters'
        'use:Switch to a different cluster context'
        'agent:Manage autonomous agents'
        'persona:Manage agent personas'
        'tool:Manage MCP tools'
        'status:Show system status and overview'
        'version:Show langop and operator version'
        'new:Generate a new tool or agent project'
        'serve:Start an MCP server for tools'
        'test:Test tool definitions'
        'run:Run an agent'
        'console:Start an interactive Ruby console'
        'help:Show help'
    )

    _arguments -C \
        '1: :->command' \
        '*::arg:->args'

    case $state in
        command)
            _describe 'langop command' commands
            ;;
        args)
            case $line[1] in
                cluster)
                    _langop_cluster
                    ;;
                use)
                    _langop_use
                    ;;
                agent)
                    _langop_agent
                    ;;
                persona)
                    _langop_persona
                    ;;
                tool)
                    _langop_tool
                    ;;
                new)
                    _langop_new
                    ;;
            esac
            ;;
    esac
}

_langop_cluster() {
    local -a subcommands
    subcommands=(
        'create:Create a new language cluster'
        'list:List all language clusters'
        'current:Show current cluster context'
        'inspect:Show detailed cluster information'
        'delete:Delete a language cluster'
    )

    _arguments -C \
        '1: :->subcommand' \
        '*::arg:->args'

    case $state in
        subcommand)
            _describe 'cluster subcommand' subcommands
            ;;
        args)
            case $line[1] in
                inspect|delete)
                    _langop_clusters
                    ;;
            esac
            ;;
    esac
}

_langop_use() {
    _langop_clusters
}

_langop_agent() {
    local -a subcommands
    subcommands=(
        'create:Create a new autonomous agent'
        'list:List agents in current cluster'
        'inspect:Show detailed agent information'
        'delete:Delete an agent'
        'logs:View agent execution logs'
        'code:Display synthesized agent code'
        'edit:Edit agent instructions'
        'pause:Pause scheduled agent execution'
        'resume:Resume paused agent'
    )

    _arguments -C \
        '1: :->subcommand' \
        '*::arg:->args'

    case $state in
        subcommand)
            _describe 'agent subcommand' subcommands
            ;;
        args)
            case $line[1] in
                create)
                    _arguments \
                        '--cluster=[Override current cluster context]:cluster:_langop_clusters' \
                        '--create-cluster=[Create cluster inline]:name:' \
                        '--persona=[Use specific persona]:persona:_langop_personas' \
                        '--dry-run[Preview without creating]'
                    ;;
                list)
                    _arguments \
                        '--all-clusters[Show agents from all clusters]' \
                        '--cluster=[Show agents from specific cluster]:cluster:_langop_clusters'
                    ;;
                inspect|delete|logs|code|edit|pause|resume)
                    _langop_agents
                    ;;
            esac
            ;;
    esac
}

_langop_persona() {
    local -a subcommands
    subcommands=(
        'list:List available personas'
        'show:Display full persona details'
        'create:Create a new custom persona'
        'edit:Edit an existing persona'
        'delete:Delete a persona'
    )

    _arguments -C \
        '1: :->subcommand' \
        '*::arg:->args'

    case $state in
        subcommand)
            _describe 'persona subcommand' subcommands
            ;;
        args)
            case $line[1] in
                create)
                    _arguments \
                        '--from=[Inherit from existing persona]:persona:_langop_personas' \
                        '--cluster=[Override current cluster]:cluster:_langop_clusters'
                    ;;
                show|edit|delete)
                    _langop_personas
                    ;;
            esac
            ;;
    esac
}

_langop_tool() {
    local -a subcommands
    subcommands=(
        'list:List tools in current cluster'
        'install:Install a new MCP tool'
        'auth:Configure tool authentication'
        'test:Test tool connectivity'
        'delete:Delete a tool'
    )

    _arguments -C \
        '1: :->subcommand' \
        '*::arg:->args'

    case $state in
        subcommand)
            _describe 'tool subcommand' subcommands
            ;;
        args)
            case $line[1] in
                auth|test|delete)
                    _langop_tools
                    ;;
                list)
                    _arguments \
                        '--cluster=[Override current cluster]:cluster:_langop_clusters'
                    ;;
            esac
            ;;
    esac
}

_langop_new() {
    local -a types
    types=('tool:Generate a new tool project' 'agent:Generate a new agent project')
    _describe 'project type' types
}

# Helper functions for dynamic completion

_langop_clusters() {
    local -a clusters
    clusters=(${(f)"$(langop cluster list 2>/dev/null | tail -n +2 | awk '{print $1}' | grep -v '^─' | grep -v '^NAME')"})
    _describe 'cluster' clusters
}

_langop_agents() {
    local -a agents
    agents=(${(f)"$(langop agent list 2>/dev/null | tail -n +2 | awk '{print $1}' | grep -v '^─' | grep -v '^NAME')"})
    _describe 'agent' agents
}

_langop_personas() {
    local -a personas
    personas=(${(f)"$(langop persona list 2>/dev/null | tail -n +2 | awk '{print $1}' | grep -v '^─' | grep -v '^NAME')"})
    _describe 'persona' personas
}

_langop_tools() {
    local -a tools
    tools=(${(f)"$(langop tool list 2>/dev/null | tail -n +2 | awk '{print $1}' | grep -v '^─' | grep -v '^NAME')"})
    _describe 'tool' tools
}

_langop "$@"
